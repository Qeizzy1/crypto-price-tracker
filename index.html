<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VexApi Pro - Crypto Tracker</title>
<style>
  /* Reset and base */
  * {box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
  body {
    background: #121720;
    color: #a0d8f7;
    padding: 20px;
    user-select: none;
    min-height: 100vh;
  }
  h1 {
    color: #38c7ff;
    margin-bottom: 15px;
    text-align: center;
    text-shadow: 0 0 8px #1de9b6, 0 0 16px #38c7ff;
  }
  /* Header */
  #header {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-bottom: 15px;
    gap: 10px;
  }
  #welcome-msg {
    margin-right: auto;
    font-weight: 700;
    font-size: 1.2rem;
    color: #00ffe7;
  }
  button {
    background: #263544cc;
    border: none;
    color: #80e8ffcc;
    padding: 8px 14px;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.3s;
    user-select: none;
  }
  button:hover {
    background: #1c2a3bdd;
    color: #00f4ff;
  }
  input[type="text"], input[type="email"], input[type="password"] {
    background: #112133;
    border: none;
    border-radius: 12px;
    color: #6bf3ff;
    padding: 10px 14px;
    font-size: 1rem;
    width: 250px;
    user-select: text;
  }
  input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus {
    outline: none;
    box-shadow: 0 0 12px #00ffe7cc;
  }
  /* Search box */
  #search-container {
    text-align: center;
    margin-bottom: 10px;
  }
  /* Table */
  table {
    width: 100%;
    border-collapse: collapse;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 0 25px #00ffe7aa;
  }
  thead {
    background: #0f1829;
  }
  th, td {
    padding: 12px 15px;
    text-align: left;
    font-size: 1rem;
    color: #a0d8f7;
  }
  th {
    cursor: pointer;
    user-select: none;
    position: relative;
  }
  tr:nth-child(even) {
    background: #0b1220;
  }
  tr:hover {
    background: #112933dd;
  }
  .price-up {
    color: #33ff99;
    text-shadow: 0 0 6px #33ff99aa;
  }
  .price-down {
    color: #ff3366;
    text-shadow: 0 0 6px #ff3366aa;
  }
  a.coin-link {
    color: #00bfff;
    font-weight: 700;
    text-decoration: none;
  }
  a.coin-link:hover {
    text-decoration: underline;
  }
  /* Pagination */
  .pagination {
    margin-top: 15px;
    text-align: center;
    user-select: none;
  }
  .pagination button {
    margin: 0 5px;
    padding: 8px 14px;
    border-radius: 12px;
    border: none;
    background: #263544cc;
    color: #80e8ffcc;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.3s;
  }
  .pagination button:hover {
    background: #1c2a3bdd;
    color: #00f4ff;
  }
  .pagination button:disabled {
    background: #444c5c;
    color: #677e96;
    cursor: not-allowed;
  }
  /* Watchlist star button */
  .watch-btn {
    background: transparent;
    border: none;
    font-size: 1.3rem;
    cursor: pointer;
    color: #444c5c;
    transition: color 0.3s ease;
    user-select: none;
  }
  .watch-btn.active {
    color: #00ffe7;
    text-shadow: 0 0 8px #00ffe7bb;
  }
  .watch-btn:hover {
    color: #00ffe7;
  }
  /* Loading spinner */
  #loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #112133;
    border-top: 5px solid #00ffe7;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 40px auto;
  }
  @keyframes spin {
    0% { transform: rotate(0deg);}
    100% { transform: rotate(360deg);}
  }
  /* Auth modal */
  #auth-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    user-select: none;
  }
  #auth-modal.active {
    display: flex;
  }
  #auth-content {
    background: #112132ee;
    padding: 25px 30px;
    border-radius: 20px;
    width: 350px;
    max-width: 90vw;
    color: #a0d8f7;
    box-shadow: 0 0 30px #00ffe7bb;
    user-select: text;
  }
  #auth-content h2 {
    color: #00ffe7;
    margin-bottom: 20px;
    text-align: center;
  }
  #auth-content label {
    display: block;
    margin: 10px 0 6px;
    font-weight: 600;
  }
  #auth-content input {
    width: 100%;
    padding: 10px;
    border-radius: 12px;
    border: none;
    background: #112133;
    color: #6bf3ff;
    font-size: 1rem;
    box-shadow:
      inset 0 0 8px #00ffe7aa,
      0 0 10px #00e2ff44;
  }
  #auth-content input:focus {
    outline: none;
    box-shadow:
      inset 0 0 12px #00ffe7ee,
      0 0 25px #00e2ffbb;
  }
  #auth-buttons {
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
  }
  #auth-buttons button {
    flex: 1;
    margin: 0 5px;
    padding: 10px;
    border-radius: 12px;
    border: none;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 0 15px #00bfffbb;
    transition: background 0.3s;
    user-select: none;
  }
  #auth-login-btn {
    background: #00bfffcc;
    color: #012b3d;
  }
  #auth-login-btn:hover {
    background: #0099ddcc;
  }
  #auth-signup-btn {
    background: #33ff99cc;
    color: #023a20;
  }
  #auth-signup-btn:hover {
    background: #27d07acc;
  }
  #auth-switch {
    margin-top: 15px;
    text-align: center;
    cursor: pointer;
    color: #55aaff;
    font-weight: 600;
    user-select: none;
  }
  #auth-switch:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<h1>VexApi Pro - Crypto Tracker</h1>

<div id="header">
  <div id="welcome-msg"></div>
  <button id="btn-login">Login</button>
  <button id="btn-logout" style="display:none;">Logout</button>
</div>

<div id="search-container" style="text-align:center; margin-bottom:10px;">
  <input type="text" id="search" placeholder="Search coins by name or symbol..." autocomplete="off" />
</div>

<div id="loading-spinner"></div>

<table id="coins-table" style="display:none;">
  <thead>
    <tr>
      <th>â˜…</th>
      <th data-key="name">Name</th>
      <th data-key="symbol">Symbol</th>
      <th data-key="current_price">Price (USD)</th>
      <th data-key="price_change_percentage_24h">24h Change %</th>
      <th data-key="market_cap">Market Cap</th>
      <th>Link</th>
    </tr>
  </thead>
  <tbody id="coin-tbody"></tbody>
</table>

<div class="pagination" id="pagination"></div>

<!-- Auth modal -->
<div id="auth-modal" role="dialog" aria-modal="true" aria-labelledby="auth-title">
  <div id="auth-content">
    <h2 id="auth-title">Login</h2>
    <form id="auth-form">
      <label for="auth-email">Email:</label>
      <input type="email" id="auth-email" required autocomplete="username" />
      <label for="auth-password">Password:</label>
      <input type="password" id="auth-password" required autocomplete="current-password" />
      <div id="auth-buttons">
        <button type="submit" id="auth-login-btn">Login</button>
        <button type="button" id="auth-signup-btn">Sign Up</button>
      </div>
    </form>
    <p id="auth-switch">Don't have an account? Sign Up</p>
  </div>
</div>

<script>
(() => {
  const spinner = document.getElementById('loading-spinner');
  const table = document.getElementById('coins-table');
  const tbody = document.getElementById('coin-tbody');
  const searchInput = document.getElementById('search');
  const pagination = document.getElementById('pagination');
  const btnLogin = document.getElementById('btn-login');
  const btnLogout = document.getElementById('btn-logout');
  const welcomeMsg = document.getElementById('welcome-msg');
  const authModal = document.getElementById('auth-modal');
  const authForm = document.getElementById('auth-form');
  const authTitle = document.getElementById('auth-title');
  const authEmail = document.getElementById('auth-email');
  const authPassword = document.getElementById('auth-password');
  const authLoginBtn = document.getElementById('auth-login-btn');
  const authSignupBtn = document.getElementById('auth-signup-btn');
  const authSwitch = document.getElementById('auth-switch');

  let coins = [];
  let filteredCoins = [];
  let currentPage = 1;
  const coinsPerPage = 30;
  let currentSort = { key: 'market_cap', order: 'desc' };
  let loggedInUser = null;
  let users = JSON.parse(localStorage.getItem('vexapi-users') || '{}');
  let watchlist = {};

  // Util functions
  function saveUsers() {
    localStorage.setItem('vexapi-users', JSON.stringify(users));
  }
  function hashPassword(pw) {
    let hash = 0;
    for(let i=0; i<pw.length; i++) {
      hash = ((hash << 5) - hash) + pw.charCodeAt(i);
      hash |= 0;
    }
    return hash.toString();
  }
  function saveWatchlist() {
    if(!loggedInUser) return;
    localStorage.setItem(`vexapi-watchlist-${loggedInUser}`, JSON.stringify(watchlist));
  }
  function loadWatchlist() {
    if(!loggedInUser) return;
    watchlist = JSON.parse(localStorage.getItem(`vexapi-watchlist-${loggedInUser}`) || '{}');
  }

  // Auth UI updates
  function setLoggedInUser(email) {
    loggedInUser = email;
    loadWatchlist();
    welcomeMsg.textContent = `Welcome, ${email}`;
    btnLogin.style.display = 'none';
    btnLogout.style.display = 'inline-block';
  }
  function logoutUser() {
    loggedInUser = null;
    watchlist = {};
    welcomeMsg.textContent = '';
    btnLogin.style.display = 'inline-block';
    btnLogout.style.display = 'none';
    saveWatchlist();
    renderTable();
  }

  // Show auth modal login/signup mode
  function showAuthModal(isLogin = true) {
    authModal.classList.add('active');
    authTitle.textContent = isLogin ? 'Login' : 'Sign Up';
    authLoginBtn.style.display = isLogin ? 'inline-block' : 'none';
    authSignupBtn.style.display = isLogin ? 'none' : 'inline-block';
    authSwitch.textContent = isLogin ? "Don't have an account? Sign Up" : "Already have an account? Login";
    authEmail.value = '';
    authPassword.value = '';
    authEmail.focus();
    authForm.dataset.mode = isLogin ? 'login' : 'signup';
  }
  function hideAuthModal() {
    authModal.classList.remove('active');
  }

  // Fetch coins from CoinGecko
  async function fetchCoins() {
    spinner.style.display = 'block';
    table.style.display = 'none';
    try {
      const response = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=1&sparkline=false`);
      const data = await response.json();
      coins = data;
      applyFiltersAndSort();
    } catch (e) {
      alert('Error fetching coin data, please try again later.');
      console.error(e);
    }
    spinner.style.display = 'none';
  }

  // Apply search filter + sorting
  function applyFiltersAndSort() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    filteredCoins = coins.filter(c => c.name.toLowerCase().includes(searchTerm) || c.symbol.toLowerCase().includes(searchTerm));
    // Sort
    filteredCoins.sort((a,b) => {
      let valA = a[currentSort.key];
      let valB = b[currentSort.key];
      // Special for name sorting string
      if(currentSort.key === 'name') {
        valA = valA.toLowerCase();
        valB = valB.toLowerCase();
        if(valA < valB) return currentSort.order === 'asc' ? -1 : 1;
        if(valA > valB) return currentSort.order === 'asc' ? 1 : -1;
        return 0;
      }
      // For null/undefined safety
      if(valA === null || valA === undefined) return 1;
      if(valB === null || valB === undefined) return -1;
      if(currentSort.order === 'asc') return valA - valB;
      else return valB - valA;
    });
    currentPage = 1; // Reset page on new search/sort
    renderTable();
    renderPagination();
  }

  // Render table rows
  function renderTable() {
    if(filteredCoins.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:#55aaff;">No coins found.</td></tr>`;
      table.style.display = 'table';
      return;
    }
    const start = (currentPage-1)*coinsPerPage;
    const end = start + coinsPerPage;
    const pageCoins = filteredCoins.slice(start, end);
    tbody.innerHTML = '';
    for(const coin of pageCoins) {
      const tr = document.createElement('tr');

      // Watchlist star button
      const starTd = document.createElement('td');
      const starBtn = document.createElement('button');
      starBtn.innerHTML = 'â˜…';
      starBtn.classList.add('watch-btn');
      if(watchlist[coin.id]) starBtn.classList.add('active');
      starBtn.title = watchlist[coin.id] ? 'Remove from watchlist' : 'Add to watchlist';
      starBtn.addEventListener('click', () => {
        if(!loggedInUser) {
          alert('Please login to use watchlist.');
          return;
        }
        if(watchlist[coin.id]) delete watchlist[coin.id];
        else watchlist[coin.id] = true;
        saveWatchlist();
        renderTable();
      });
      starTd.appendChild(starBtn);
      tr.appendChild(starTd);

      // Name with image
      const nameTd = document.createElement('td');
      nameTd.innerHTML = `<img src="${coin.image}" alt="${coin.name}" style="width:20px; height:20px; vertical-align:middle; margin-right:8px; border-radius:50%;"> ${coin.name}`;
      tr.appendChild(nameTd);

      // Symbol
      const symTd = document.createElement('td');
      symTd.textContent = coin.symbol.toUpperCase();
      tr.appendChild(symTd);

      // Current Price
      const priceTd = document.createElement('td');
      priceTd.textContent = coin.current_price !== null ? `$${coin.current_price.toLocaleString()}` : 'N/A';
      tr.appendChild(priceTd);

      // 24h Change
      const changeTd = document.createElement('td');
      const change = coin.price_change_percentage_24h;
      changeTd
